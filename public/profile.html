<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Cá Nhân - TimeLuxe</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Sidebar Menu Hover Effects */
        .sidebar-menu-item {
            transition: all 0.3s ease !important;
        }
        
        .sidebar-menu-item:not(.active):hover {
            background: #f5f5f5 !important;
            color: #4285f4 !important;
            border-left-color: #4285f4 !important;
        }
        
        /* Profile Section Display */
        .profile-section {
            display: none;
        }
        
        .profile-section.active {
            display: block;
        }
        
        /* Orders Container */
        .orders-container {
            min-height: 300px;
        }
        
        .order-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #7c6240;
            background: transparent;
            color: #7c6240;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            background: #7c6240;
            color: #fff;
        }
        
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .order-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.2s ease;
        }
        
        .order-card:hover {
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .order-id {
            font-weight: 700;
            color: #7c6240;
        }
        
        .order-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        .order-products {
            margin-bottom: 15px;
        }
        
        .product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .product-info h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
        }
        
        .product-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-total {
            font-weight: 700;
            color: #e53935;
            font-size: 1.1rem;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-detail {
            background: #7c6240;
            color: #fff;
        }
        
        .btn-detail:hover {
            background: #a4845c;
        }
        
        .btn-reorder {
            background: #28a745;
            color: #fff;
        }
        
        .btn-reorder:hover {
            background: #218838;
        }
        
        /* Wishlist Tab */
        .wishlist-container {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 28px;
        }
        
        .wishlist-item {
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s ease;
            position: relative;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .wishlist-item:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-3px);
            border-color: #667eea;
        }
        
        .remove-wishlist {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            z-index: 10;
        }
        
        .remove-wishlist:hover {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 6px 18px rgba(231, 76, 60, 0.4);
        }
        
        .remove-wishlist:active {
            transform: scale(0.95);
        }
        
        .wishlist-product {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            align-items: center;
        }
        
        .wishlist-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .wishlist-info {
            flex: 1;
        }
        
        .wishlist-info h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .wishlist-price {
            color: #e53935;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .wishlist-actions {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }
        
        .wishlist-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }
        
        .wishlist-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .wishlist-btn.loading {
            pointer-events: none;
        }
        
        .wishlist-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-add-cart {
            background: linear-gradient(135deg, #7c6240 0%, #a4845c 100%);
            color: #fff;
            border: none;
            box-shadow: 0 4px 15px rgba(124, 98, 64, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-add-cart::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-add-cart:hover {
            background: linear-gradient(135deg, #a4845c 0%, #7c6240 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 98, 64, 0.4);
        }
        
        .btn-add-cart:hover::before {
            left: 100%;
        }
        
        .btn-add-cart:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(124, 98, 64, 0.3);
        }
        
        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-size: 0.85rem;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-view::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-view:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
            color: #fff;
            border-radius: 10px;
        }
        
        .btn-view:hover::before {
            left: 100%;
        }
        
        .btn-view:active {
            transform: translateY(-1px) scale(0.95);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            border-radius: 6px;
        }
        
        .btn-view:focus {
            outline: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), 0 0 0 3px rgba(102, 126, 234, 0.3);
            border-radius: 10px;
        }
        
        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-state p {
            margin-bottom: 20px;
        }
        
        .back-to-shop {
            display: inline-block;
            padding: 12px 24px;
            background: #7c6240;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s ease;
        }
        
        .back-to-shop:hover {
            background: #a4845c;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            aside {
                width: 220px !important;
            }
            
            section[style*="flex: 1"] {
                padding: 20px !important;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .order-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .wishlist-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .wishlist-item {
                padding: 20px;
                margin: 0;
            }
            
            .wishlist-product {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .wishlist-image {
                width: 100px;
                height: 100px;
                margin: 0 auto;
                border-radius: 8px;
            }
            
            .wishlist-info h4 {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .wishlist-price {
                font-size: 1.2rem;
            }
            
            .wishlist-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .wishlist-btn {
                width: 100%;
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .btn-view {
                font-size: 0.8rem;
                letter-spacing: 0.2px;
                padding: 10px 14px;
                min-height: 40px;
            }
            
            .remove-wishlist {
                top: 12px;
                right: 12px;
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .profile-container {
                margin: 15px auto;
                padding: 0 10px;
            }
            
            .profile-header h1 {
                font-size: 1.8rem;
            }
            
            .nav-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .wishlist-item {
                padding: 15px;
            }
            
            .wishlist-image {
                width: 80px;
                height: 80px;
            }
            
            .wishlist-info h4 {
                font-size: 1rem;
            }
            
            .wishlist-price {
                font-size: 1.1rem;
            }
            
            .wishlist-btn {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .btn-view {
                font-size: 0.75rem;
                letter-spacing: 0.1px;
                padding: 8px 10px;
                min-height: 36px;
            }
            
            .remove-wishlist {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="dhda-header">
        <!-- Top bar -->
        <div class="dhda-topbar">
            <div class="container dhda-topbar-flex">
                <div class="dhda-topbar-left">
                    <span class="dhda-hotline"><i class="fas fa-phone"></i> Hotline: <a href="tel:0834477085">0834477085</a></span>
                    <span class="dhda-address"><i class="fas fa-map-marker-alt"></i> 68 Nguyễn Chí Thanh, Hà Nội</span>
                </div>
                <div class="dhda-topbar-right">
                    <div id="guest-section" style="display: flex;">
                        <a href="login.html" class="dhda-login"><i class="fas fa-user"></i> Đăng nhập</a>
                    </div>
                    <div id="user-section" style="display: none; align-items: center; gap: 8px;">
                        <span>Xin chào, <span id="user-display-name"></span></span>
                        <a href="profile.html" style="color: #7c6240; margin-left: 8px;"><i class="fas fa-user"></i> Cá nhân</a>
                        <a href="#" id="logout-btn" style="color: #e53935; margin-left: 8px;">Đăng xuất</a>
                    </div>
                    <a href="#" class="dhda-cart" onclick="showCartPopup()"><i class="fas fa-shopping-cart"></i> Giỏ hàng <span class="cart-count">0</span></a>
                </div>
            </div>
        </div>
        <!-- Logo + Menu + Search -->
        <div class="dhda-header-main" style="background: #7c6240;">
            <div class="container dhda-header-main-flex" style="display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 30px; padding: 15px 0;">
                <a href="index.html" class="dhda-logo">
                    <img src="images/logos/logo TIME LUXE.png" alt="TimeLuxe Logo" style="height: 120px; width: 120px; object-fit: contain;" />
                </a>
        <!-- Menu ngang -->
                <nav class="dhda-menu" style="flex: 1; display: flex; justify-content: center; max-width: 700px;">
                    <ul class="dhda-menu-list" style="display: flex; gap: 25px; list-style: none; margin: 0; padding: 0; width: 100%; justify-content: space-evenly;">
                        <li><a href="index.html#brands" class="menu-link" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 15px; padding: 10px 15px; display: block; transition: all 0.3s; border-radius: 5px;">THƯƠNG HIỆU</a></li>
                        <li><a href="donghotreotuong.html" class="menu-link" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 15px; padding: 10px 15px; display: block; transition: all 0.3s; border-radius: 5px;">ĐỒNG HỒ TREO TƯỜNG</a></li>
                        <li><a href="daydongho.html" class="menu-link" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 15px; padding: 10px 15px; display: block; transition: all 0.3s; border-radius: 5px;">DÂY ĐỒNG HỒ</a></li>
                        <li><a href="sanphamkhac.html" class="menu-link" style="color: #000000; text-decoration: none; font-weight: 600; font-size: 15px; padding: 10px 15px; display: block; transition: all 0.3s; border-radius: 5px;">SẢN PHẨM KHÁC</a></li>
                </ul>
        </nav>
                <form class="dhda-search-bar" style="display: flex; min-width: 300px;" id="searchForm">
                    <input type="text" placeholder="Tìm kiếm sản phẩm, thương hiệu..." style="flex: 1;" id="searchInput" />
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
            </div>
        </div>
    </header>

    <main class="profile-container" style="max-width: 1400px; margin: 0 auto; padding: 0;">
        <!-- Page Title -->
        <div style="background: #f8f9fa; padding: 20px 40px; border-bottom: 1px solid #e0e0e0;">
            <h2 style="margin: 0; color: #333; font-size: 1.5rem; font-weight: 600;">Trang cá nhân</h2>
        </div>

        <!-- Profile Layout: Sidebar + Content -->
        <div style="display: flex; min-height: 600px; background: #fff;">
            
            <!-- Left Sidebar -->
            <aside style="width: 280px; background: #fff; border-right: 1px solid #e0e0e0; padding: 30px 0;">
                <!-- User Info -->
                <div style="text-align: center; padding: 0 20px 30px; border-bottom: 1px solid #f0f0f0;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; overflow: hidden; border: 3px solid #7c6240;">
                        <img id="sidebar-avatar" src="https://ui-avatars.com/api/?name=User&background=7c6240&color=fff&size=80" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" />
                    </div>
                    <div style="font-size: 0.9rem; color: #999;">Xin chào</div>
                    <div id="sidebar-username" style="font-size: 1.1rem; font-weight: 600; color: #333; margin-top: 5px;">Đang tải...</div>
                </div>

                <!-- Menu Items -->
                <nav style="padding: 20px 0;">
                    <a href="#" class="sidebar-menu-item active" data-section="my-account" style="display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #fff; background: #4285f4; text-decoration: none; transition: all 0.3s; border-left: 4px solid #1a73e8;">
                        <i class="fas fa-user" style="width: 20px; font-size: 1rem;"></i>
                        <span style="font-size: 0.95rem; font-weight: 500;">Tài khoản</span>
                    </a>
                    <a href="#" class="sidebar-menu-item" data-section="my-orders" style="display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #555; text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent;">
                        <i class="fas fa-shopping-bag" style="width: 20px; font-size: 1rem;"></i>
                        <span style="font-size: 0.95rem; font-weight: 500;">Đơn hàng</span>
                    </a>
                    <a href="#" class="sidebar-menu-item" data-section="my-rating" style="display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #555; text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent;">
                        <i class="fas fa-star" style="width: 20px; font-size: 1rem;"></i>
                        <span style="font-size: 0.95rem; font-weight: 500;">Đánh giá</span>
                    </a>
                    <a href="#" class="sidebar-menu-item" data-section="my-wishlist" style="display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #555; text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent;">
                        <i class="fas fa-heart" style="width: 20px; font-size: 1rem;"></i>
                        <span style="font-size: 0.95rem; font-weight: 500;">Yêu thích</span>
                    </a>
                    <a href="#" class="sidebar-menu-item" data-section="change-password" style="display: flex; align-items: center; gap: 12px; padding: 14px 25px; color: #555; text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent;">
                        <i class="fas fa-lock" style="width: 20px; font-size: 1rem;"></i>
                        <span style="font-size: 0.95rem; font-weight: 500;">Đổi mật khẩu</span>
                    </a>
                </nav>
            </aside>

            <!-- Right Content Area -->
            <section style="flex: 1; padding: 40px; background: #fafafa;">
                
                <!-- My Account Section (Active by default) -->
                <div id="my-account-section" class="profile-section active">
                    <div style="background: #fff; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px;">
                            <h3 style="margin: 0; color: #333; font-size: 1.4rem; font-weight: 600;">Thông tin cá nhân</h3>
                            <button type="button" onclick="enableEditProfile()" style="color: #4285f4; background: none; border: none; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; font-weight: 500;">
                                <i class="fas fa-edit"></i> Chỉnh sửa thông tin
            </button>
        </div>

                        <div style="display: flex; gap: 40px; align-items: flex-start;">
                            <!-- Avatar -->
                            <div style="text-align: center;">
                                <div style="position: relative; display: inline-block;">
                                    <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #e0e0e0;">
                                        <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=7c6240&color=fff&size=120" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" />
                </div>
                                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarChange(event)">
                                    <button onclick="triggerAvatarUpload()" type="button" style="position: absolute; bottom: 5px; right: 5px; width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 2px solid #4285f4; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-camera" style="color: #4285f4; font-size: 0.75rem;"></i>
                                    </button>
                </div>
                                <p style="margin: 10px 0 0 0; color: #666; font-size: 0.85rem;">Click vào icon để đổi ảnh</p>
                </div>

                            <!-- Form -->
                            <form id="profileForm" style="flex: 1; max-width: 600px;">
                                <!-- Name -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Họ và tên</label>
                                    <input type="text" id="fullName" name="fullName" placeholder="Đang tải..." readonly style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; background: #f8f9fa; color: #666;">
            </div>

                                <!-- Date of Birth -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Ngày sinh</label>
                                    <input type="text" id="dateOfBirth" name="dateOfBirth" placeholder="DD/MM/YYYY" readonly style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; background: #f8f9fa; color: #666;">
                                </div>

                                <!-- Gender -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; color: #333; font-weight: 600; font-size: 0.95rem;">Giới tính</label>
                                    <div style="display: flex; gap: 30px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="gender" value="male" disabled style="width: 18px; height: 18px; accent-color: #4CAF50;">
                                            <span style="color: #666; font-size: 0.95rem;">Nam</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="gender" value="female" disabled style="width: 18px; height: 18px; accent-color: #e0e0e0;">
                                            <span style="color: #666; font-size: 0.95rem;">Nữ</span>
                                        </label>
            </div>
        </div>

                                <!-- Phone Number -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Số điện thoại</label>
                                    <div style="display: flex; gap: 10px;">
                                        <div style="display: flex; align-items: center; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f8f9fa; gap: 8px;">
                                            <span style="font-size: 1.2rem;">🇻🇳</span>
                                            <span style="color: #666; font-size: 0.95rem;">+84</span>
                    </div>
                                        <input type="tel" id="phone" name="phone" placeholder="Đang tải..." readonly style="flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; background: #f8f9fa; color: #666;">
                    </div>
                    </div>

                                <!-- Email -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Email</label>
                                    <input type="email" id="email" name="email" placeholder="Đang tải..." readonly style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; background: #f8f9fa; color: #666;">
                    </div>

                                <!-- Save Button (hidden by default) -->
                                <button type="submit" id="saveProfileBtn" style="display: none; padding: 12px 30px; background: #7c6240; color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">
                                    <i class="fas fa-save"></i> Lưu thay đổi
                    </button>
                </form>
                        </div>
            </div>
        </div>

                <!-- My Orders Section -->
                <div id="my-orders-section" class="profile-section" style="display: none;">
                    <div style="background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.4rem; font-weight: 600;">Đơn hàng của tôi</h3>
                <div class="order-filters">
                    <button class="filter-btn active" data-filter="all">Tất cả</button>
                    <button class="filter-btn" data-filter="pending">Chờ xử lý</button>
                    <button class="filter-btn" data-filter="processing">Đang xử lý</button>
                    <button class="filter-btn" data-filter="delivered">Đã giao</button>
                    <button class="filter-btn" data-filter="cancelled">Đã hủy</button>
                </div>
                <div id="ordersList" class="order-list">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>

                <!-- My Rating & Reviews Section -->
                <div id="my-rating-section" class="profile-section" style="display: none;">
                    <div style="background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-star" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #333; margin-bottom: 10px;">Đánh giá của tôi</h3>
                        <p style="color: #666; margin-bottom: 20px;">Bạn chưa có đánh giá nào</p>
                    </div>
                </div>

                <!-- My Wishlist Section -->
                <div id="my-wishlist-section" class="profile-section" style="display: none;">
                    <div style="background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.4rem; font-weight: 600;">
                            <i class="fas fa-heart" style="color: #e53935;"></i> Sản Phẩm Yêu Thích
                </h3>
                <div id="wishlistGrid" class="wishlist-grid">
                    <!-- Wishlist items will be loaded here -->
                </div>
            </div>
                </div>

                <!-- Change Password Section -->
                <div id="change-password-section" class="profile-section" style="display: none;">
                    <div style="background: #fff; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 500px;">
                        <h3 style="margin: 0 0 25px 0; color: #333; font-size: 1.4rem; font-weight: 600;">Đổi mật khẩu</h3>
                        <form id="changePasswordForm">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Mật khẩu hiện tại</label>
                                <input type="password" id="currentPassword" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Mật khẩu mới</label>
                                <input type="password" id="newPassword" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95rem;">Xác nhận mật khẩu mới</label>
                                <input type="password" id="confirmPassword" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                            </div>
                            <button type="submit" style="padding: 12px 30px; background: #7c6240; color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-lock"></i> Đổi Mật Khẩu
                            </button>
                        </form>
                    </div>
                </div>

            </section>
        </div>
    </main>

    <footer class="site-footer clean-footer" style="margin-top: 50px;">
        <div class="container">
        <div class="footer-grid">
            <div class="footer-col">
                <h4>TimeLuxe</h4>
                <ul>
                    <li><a href="about.html">Giới thiệu</a></li>
                    <li><a href="customers.html">Đánh giá khách hàng</a></li>
                    <li><a href="guide.html">Hướng dẫn sử dụng</a></li>
                    <li><a href="repair.html">Dịch vụ sửa chữa</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Liên hệ</h4>
                <ul class="footer-contact-list">
                    <li><i class="fas fa-phone"></i> 0834477085</li>
                    <li><i class="fas fa-envelope"></i> timeluxe@gmail.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> 68 Nguyễn Chí Thanh, Hà Nội</li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Kết nối</h4>
                <div class="footer-social">
                    <a href="https://facebook.com" target="_blank" rel="noopener" class="fb" aria-label="Facebook">
                        <img src="images/icons/icon-facebook.png" alt="Facebook" loading="lazy" />
                    </a>
                    <a href="https://instagram.com" target="_blank" rel="noopener" class="ig" aria-label="Instagram">
                        <img src="images/icons/icon-instagram.png" alt="Instagram" loading="lazy" />
                    </a>
                </div>
            </div>
        </div>
        <div class="footer-bottom" style="text-align: center; padding: 20px 0; border-top: 1px solid rgba(255,255,255,0.1);">
            <span>&copy; 2023 TimeLuxe. All rights reserved.</span>
        </div>
        </div>
    </footer>
    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeOrderDetailModal()">&times;</span>
            <div id="orderDetailContent">
                <!-- Order detail content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Modal chi tiết đơn hàng -->
    <div id="orderDetailModal" class="modal" style="display:none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div style="padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #333; font-size: 1.5rem;">Chi tiết đơn hàng</h2>
                <span onclick="closeOrderDetailModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <div id="orderDetailContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Modal xác nhận hủy đơn hàng -->
    <div id="cancelOrderModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:400px;margin:auto;padding:32px 24px;border-radius:12px;background:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.18);text-align:center;">
        <h3 style="color:#e53935;margin-bottom:18px;"><i class="fas fa-exclamation-triangle"></i> Xác nhận hủy đơn hàng</h3>
        <div id="cancelOrderText" style="margin-bottom:24px;">Bạn chắc chắn muốn hủy đơn hàng này?</div>
        <button id="confirmCancelOrderBtn" style="background:#e53935;color:#fff;padding:10px 24px;border:none;border-radius:6px;margin-right:10px;font-weight:600;">Hủy đơn</button>
        <button id="closeCancelOrderBtn" style="background:#888;color:#fff;padding:10px 24px;border:none;border-radius:6px;font-weight:600;">Đóng</button>
      </div>
    </div>
    
    <!-- Cart Popup JavaScript -->
    <script>
    // ========== NOTIFICATION SYSTEM ==========
    function showNotification(message, type = 'info') {
        // Remove existing notification
        const existing = document.getElementById('notification-toast');
        if (existing) existing.remove();
        
        // Create notification
        const notification = document.createElement('div');
        notification.id = 'notification-toast';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 99999;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
            min-width: 280px;
            max-width: 400px;
        `;
        
        const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : type === 'warning' ? '⚠' : 'ℹ';
        notification.innerHTML = `
            <span style="font-size: 1.2rem; font-weight: 700;">${icon}</span>
            <span style="flex: 1;">${message}</span>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; padding: 0; opacity: 0.8;">×</button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (notification && notification.parentElement) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }
        }, 4000);
    }
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    async function showCartPopup() {
        // Prevent multiple popups
        if (window._originalShowCartPopup) return window._originalShowCartPopup();
        
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const cartBtn = document.querySelector('.dhda-cart');
        
        let rect = cartBtn ? cartBtn.getBoundingClientRect() : {top:70,right:30};
        let top = rect.bottom + window.scrollY + 8;
        let left = rect.right + window.scrollX - 360;
        if (left < 8) left = 8;
        
        let html = `<div class="cart-popup" style="position:absolute;top:${top}px;left:${left}px;z-index:9999;background:#fff;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.18);padding:24px 18px;min-width:320px;max-width:95vw;max-height:70vh;overflow:auto;">`;
        html += '<h3 style="margin-bottom:14px;font-size:1.18rem;color:#7c6240;letter-spacing:1px;">🛒 Giỏ hàng</h3>';
        
        if (cart.length === 0) {
            html += '<div style="padding:18px 0;text-align:center;color:#888;">Chưa có sản phẩm nào.</div>';
        } else {
            html += '<table style="width:100%;border-collapse:collapse;font-size:0.98rem;">';
            html += '<thead><tr style="background:#f8f9fa;"><th style="text-align:left;padding:6px 2px;">Tên</th><th>SL</th><th>Đơn giá</th><th></th></tr></thead><tbody>';
            let total = 0;
            cart.forEach((item, idx) => {
                const price = item.price || 0;
                const lineTotal = price * item.quantity;
                total += lineTotal;
                html += `<tr style='border-bottom:1px solid #eee;'>
                    <td style='padding:6px 2px;'>${item.name}</td>
                    <td style='min-width:60px;'>
                        <button class='cart-qty-btn' data-idx='${idx}' data-action='decrease' style='padding:2px 8px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;font-weight:700;'>-</button>
                        <span style='margin:0 6px;font-weight:600;'>${item.quantity}</span>
                        <button class='cart-qty-btn' data-idx='${idx}' data-action='increase' style='padding:2px 8px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;font-weight:700;'>+</button>
                    </td>
                    <td style='color:#7c6240;font-weight:600;'>${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(price)}</td>
                    <td><button class='cart-remove-btn' data-idx='${idx}' style='color:#e53935;background:none;border:none;font-size:1.1rem;cursor:pointer;' title='Xóa'>&times;</button></td>
                </tr>`;
            });
            html += `</tbody></table><div style='margin-top:10px;font-weight:700;font-size:1.05rem;text-align:right;'>Tổng: <span id='cart-total' style='color:#e53935;'>${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(total)}</span></div>`;
            html += `<button onclick='checkoutCart()' style='margin-top:14px;padding:8px 22px;border:none;background:#7c6240;color:#fff;border-radius:7px;cursor:pointer;font-size:1rem;font-weight:600;'>Thanh toán</button>`;
        }
        html += '<button onclick="closeCartPopup()" style="margin-top:14px;margin-left:10px;padding:7px 18px;border:none;background:#888;color:#fff;border-radius:7px;cursor:pointer;font-size:0.98rem;float:right;">Đóng</button>';
        html += '</div>';
        
        const old = document.getElementById('cart-popup');
        if (old) old.remove();
        const div = document.createElement('div');
        div.id = 'cart-popup';
        div.innerHTML = html;
        document.body.appendChild(div);
        
        // Gắn sự kiện cho nút tăng/giảm/xóa
        div.querySelectorAll('.cart-qty-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const idx = Number(this.getAttribute('data-idx'));
                const action = this.getAttribute('data-action');
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                
                if (action === 'increase') {
                    cart[idx].quantity++;
                }
                
                if (action === 'decrease' && cart[idx].quantity > 1) {
                    cart[idx].quantity--;
                }
                
                localStorage.setItem('cart', JSON.stringify(cart));
                showCartPopup();
                // Cập nhật số lượng hiển thị
                const count = cart.reduce((sum, item) => sum + item.quantity, 0);
                document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
            });
        });
        
        div.querySelectorAll('.cart-remove-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const idx = Number(this.getAttribute('data-idx'));
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                showCartPopup();
                // Cập nhật số lượng hiển thị
                const count = cart.reduce((sum, item) => sum + item.quantity, 0);
                document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
            });
        });
    }
    
    function closeCartPopup() {
        const popup = document.getElementById('cart-popup');
        if (popup) popup.remove();
    }
    
    function checkoutCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
            showNotification('Giỏ hàng trống!', 'warning');
            return;
        }
        window.location.href = 'checkout.html';
    }
    
    // Make functions globally accessible
    window.showCartPopup = showCartPopup;
    window.closeCartPopup = closeCartPopup;
    window.checkoutCart = checkoutCart;
    
    // ========== LOAD USER DATA ==========
    async function loadUserProfile() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            const response = await fetch('/api/users/profile', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                throw new Error('Failed to load profile');
            }
            
            const data = await response.json();
            const user = data.user || data;
            
            // Store user data globally for avatar management
            window.currentUser = user;
            
            // Get full name (support both snake_case and camelCase)
            const fullName = user.full_name || user.fullName || user.name || 'User';
            
            // Update sidebar
            document.getElementById('sidebar-username').textContent = fullName;
            
            // Check for avatar from database
            const avatarUrl = user.avatar ? user.avatar : `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=7c6240&color=fff&size=120`;
            
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            if (sidebarAvatar) {
                sidebarAvatar.src = avatarUrl;
            }
            
            // Update profile avatar
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                profileAvatar.src = avatarUrl;
            }
            
            // Update form fields
            document.getElementById('fullName').value = fullName;
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            
            // Update date of birth if exists
            const dateOfBirth = user.date_of_birth || user.dateOfBirth;
            if (dateOfBirth) {
                const dob = new Date(dateOfBirth);
                const formattedDate = dob.toLocaleDateString('en-GB'); // DD/MM/YYYY
                document.getElementById('dateOfBirth').value = formattedDate;
            }
            
            // Update gender if exists
            const gender = user.gender;
            if (gender) {
                const genderInput = document.querySelector(`input[name="gender"][value="${gender}"]`);
                if (genderInput) {
                    genderInput.checked = true;
                }
            }
            
            // Save user name to localStorage for header
            localStorage.setItem('userName', fullName);
            
            // Update header with user name
            updateHeaderAuthState();
            
        } catch (error) {
            console.error('Error loading profile:', error);
            showNotification('Không thể tải thông tin cá nhân!', 'error');
        }
    }
    
    // ========== UPDATE HEADER AUTH STATE ==========
    function updateHeaderAuthState() {
        const token = localStorage.getItem('token');
        const guestSection = document.getElementById('guest-section');
        const userSection = document.getElementById('user-section');
        
        if (token) {
            // Đã đăng nhập
            if (guestSection) guestSection.style.display = 'none';
            if (userSection) userSection.style.display = 'flex';
            
            // Lấy tên user từ localStorage hoặc sẽ update sau khi load profile
            const userName = localStorage.getItem('userName') || 'User';
            const userDisplayName = document.getElementById('user-display-name');
            if (userDisplayName) {
                userDisplayName.textContent = userName;
            }
        } else {
            // Chưa đăng nhập
            if (guestSection) guestSection.style.display = 'flex';
            if (userSection) userSection.style.display = 'none';
        }
    }
    
    // Handle logout
    function handleLogout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userName');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('userRole');
        showNotification('Đã đăng xuất!', 'success');
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1000);
    }
    
    // ========== SIDEBAR NAVIGATION ==========
    document.addEventListener('DOMContentLoaded', async function() {
        // Update header auth state
        updateHeaderAuthState();
        
        // Load user profile on page load (avatar will be loaded from database)
        await loadUserProfile();
        
        // Handle logout button
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
        }
        
        // Handle sidebar menu click
        const menuItems = document.querySelectorAll('.sidebar-menu-item');
        const sections = document.querySelectorAll('.profile-section');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get target section
                const targetSection = this.getAttribute('data-section');
                
                // Remove active class from all menu items
                menuItems.forEach(mi => {
                    mi.classList.remove('active');
                    mi.style.background = '';
                    mi.style.color = '#555';
                    mi.style.borderLeftColor = 'transparent';
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                this.style.background = '#4285f4';
                this.style.color = '#fff';
                this.style.borderLeftColor = '#1a73e8';
                
                // Hide all sections
                sections.forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Show target section
                const targetElement = document.getElementById(targetSection + '-section');
                if (targetElement) {
                    targetElement.classList.add('active');
                    targetElement.style.display = 'block';
                    
                    // Load data for specific sections
                    if (targetSection === 'my-orders') {
                        loadOrders();
                    } else if (targetSection === 'my-wishlist') {
                        loadWishlist();
                    }
                }
            });
        });
    });
    
    // ========== LOAD ORDERS ==========
    async function loadOrders(filter = 'all') {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            const response = await fetch('/api/orders', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load orders');
            }
            
            const data = await response.json();
            let orders = data.orders || [];
            
            // Apply filter
            if (filter !== 'all') {
                orders = orders.filter(order => order.status === filter);
            }
            
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #666;">
                        <i class="fas fa-shopping-bag" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 10px; color: #333;">Chưa có đơn hàng nào</h3>
                        <p style="margin-bottom: 20px;">Bạn chưa có đơn hàng nào${filter !== 'all' ? ' với trạng thái này' : ''}.</p>
                        <a href="index.html" class="back-to-shop" style="display: inline-block; padding: 12px 24px; background: #7c6240; color: #fff; text-decoration: none; border-radius: 6px;">Mua sắm ngay</a>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = orders.map(order => {
                const statusClass = `status-${order.status}`;
                const statusText = {
                    'pending': 'Chờ xử lý',
                    'processing': 'Đang xử lý',
                    'delivered': 'Đã giao',
                    'cancelled': 'Đã hủy'
                }[order.status] || order.status;
                
                const orderDate = new Date(order.created_at).toLocaleDateString('vi-VN');
                
                return `
                    <div class="order-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                            <div>
                                <div class="order-id" style="font-weight: 700; color: #7c6240;">Đơn hàng #${order.id}</div>
                                <div class="order-date" style="color: #666; font-size: 0.9rem;">${orderDate}</div>
                            </div>
                            <div class="order-status ${statusClass}" style="padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">${statusText}</div>
                        </div>
                        <div class="order-products" style="margin-bottom: 15px;">
                            ${order.items && order.items.length > 0 ? order.items.map(item => `
                                <div class="product-item" style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                    <img src="${item.product_image || item.image || 'images/products/dongho1.webp'}" alt="${item.product_name}" class="product-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                    <div class="product-info">
                                        <h4 style="margin: 0 0 5px 0; font-size: 1rem;">${item.product_name}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Số lượng: ${item.quantity} x ${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(item.price)}</p>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: #999; font-style: italic;">Không có sản phẩm</p>'}
                        </div>
                        <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
                            <div class="order-total" style="font-weight: 700; color: #e53935; font-size: 1.1rem;">
                                Tổng: ${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(order.total_amount)}
                            </div>
                            <div class="order-actions" style="display: flex; gap: 10px;">
                                <button onclick="viewOrderDetail(${order.id})" class="action-btn btn-detail" style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; background: #7c6240; color: #fff;">
                                    <i class="fas fa-eye"></i> Chi tiết
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('ordersList').innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #666;">
                    <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #e53935; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px; color: #333;">Không thể tải đơn hàng</h3>
                    <p>Vui lòng thử lại sau.</p>
                </div>
            `;
        }
    }
    
    // ========== LOAD WISHLIST ==========
    function loadWishlist() {
        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const wishlistGrid = document.getElementById('wishlistGrid');
        
        if (wishlist.length === 0) {
            wishlistGrid.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #666;">
                    <i class="fas fa-heart" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 10px; color: #333;">Danh sách yêu thích trống</h3>
                    <p style="margin-bottom: 20px;">Bạn chưa có sản phẩm yêu thích nào.</p>
                    <a href="index.html" class="back-to-shop" style="display: inline-block; padding: 12px 24px; background: #7c6240; color: #fff; text-decoration: none; border-radius: 6px;">Khám phá sản phẩm</a>
                </div>
            `;
            return;
        }
        
        wishlistGrid.innerHTML = wishlist.map(item => `
            <div class="wishlist-item" style="border: 1px solid #e0e0e0; border-radius: 16px; padding: 28px; position: relative; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <button onclick="removeFromWishlist(${item.id})" class="remove-wishlist" style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                    <i class="fas fa-times"></i>
                </button>
                <div class="wishlist-product" style="display: flex; gap: 24px; margin-bottom: 24px; align-items: center;">
                    <img src="${item.image}" alt="${item.name}" class="wishlist-image" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="wishlist-info" style="flex: 1;">
                        <h4 style="margin: 0 0 12px 0; color: #333; font-size: 1.2rem; font-weight: 600;">${item.name}</h4>
                        <div class="wishlist-price" style="color: #e53935; font-weight: 700; font-size: 1.3rem;">${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(item.price)}</div>
                    </div>
                </div>
                <div class="wishlist-actions" style="display: flex; gap: 16px;">
                    <button onclick="addToCartFromWishlist(${item.id})" class="wishlist-btn btn-add-cart" style="flex: 1; padding: 14px 20px; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #7c6240 0%, #a4845c 100%); color: #fff; box-shadow: 0 4px 15px rgba(124, 98, 64, 0.3);">
                        <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                    </button>
                    <a href="product.html?id=${item.id}" class="wishlist-btn btn-view" style="flex: 1; padding: 14px 20px; border: none; border-radius: 12px; cursor: pointer; font-size: 0.85rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-eye"></i> XEM
                    </a>
                </div>
            </div>
        `).join('');
    }
    
    // Handle order filter buttons
    document.addEventListener('DOMContentLoaded', function() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const filter = this.getAttribute('data-filter');
                loadOrders(filter);
            });
        });
    });
    
    // Wishlist functions
    function removeFromWishlist(productId) {
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        wishlist = wishlist.filter(item => item.id !== productId);
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        loadWishlist();
        showNotification('Đã xóa khỏi danh sách yêu thích!', 'success');
    }
    
    function addToCartFromWishlist(productId) {
        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const product = wishlist.find(item => item.id === productId);
        if (product) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            showNotification('Đã thêm vào giỏ hàng!', 'success');
            // Update cart count
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
        }
    }
    
    async function viewOrderDetail(orderId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            const response = await fetch(`/api/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load order detail');
            }
            
            const data = await response.json();
            const order = data.order;
            
            const statusText = {
                'pending': 'Chờ xử lý',
                'processing': 'Đang xử lý',
                'shipped': 'Đang giao',
                'delivered': 'Đã giao',
                'cancelled': 'Đã hủy'
            }[order.status] || order.status;
            
            const statusClass = `status-${order.status}`;
            const orderDate = new Date(order.created_at).toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #7c6240; font-size: 1.3rem;">Đơn hàng #${order.id}</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">${orderDate}</p>
                        </div>
                        <div class="order-status ${statusClass}" style="padding: 8px 20px; border-radius: 20px; font-size: 1rem; font-weight: 600;">${statusText}</div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">Thông tin người nhận</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <strong style="color: #666; font-size: 0.9rem;">Họ tên:</strong>
                            <p style="margin: 5px 0 0 0; color: #333;">${order.customer_name || 'N/A'}</p>
                        </div>
                        <div>
                            <strong style="color: #666; font-size: 0.9rem;">Số điện thoại:</strong>
                            <p style="margin: 5px 0 0 0; color: #333;">${order.customer_phone || 'Chưa cập nhật'}</p>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #666; font-size: 0.9rem;">Địa chỉ giao hàng:</strong>
                            <p style="margin: 5px 0 0 0; color: #333;">${order.customer_address || 'Chưa cập nhật'}</p>
                        </div>
                        ${order.customer_city || order.customer_district ? `
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #666; font-size: 0.9rem;">Khu vực:</strong>
                            <p style="margin: 5px 0 0 0; color: #333;">${[order.customer_district, order.customer_city].filter(Boolean).join(', ')}</p>
                        </div>
                        ` : ''}
                        ${order.customer_note ? `
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #666; font-size: 0.9rem;">Ghi chú:</strong>
                            <p style="margin: 5px 0 0 0; color: #333;">${order.customer_note}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">Sản phẩm</h4>
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
            `;
            
            if (order.items && order.items.length > 0) {
                order.items.forEach((item, index) => {
                    html += `
                        <div style="display: flex; align-items: center; padding: 15px; gap: 15px; ${index > 0 ? 'border-top: 1px solid #e0e0e0;' : ''}">
                            <img src="${item.product_image || 'images/products/dongho1.webp'}" alt="${item.product_name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0; color: #333; font-size: 1rem;">${item.product_name}</h5>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">Số lượng: ${item.quantity}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #7c6240; font-weight: 600; font-size: 1rem;">${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(item.price)}</div>
                                <div style="color: #999; font-size: 0.85rem;">x ${item.quantity}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<div style="padding: 20px; text-align: center; color: #999;">Không có sản phẩm</div>`;
            }
            
            html += `
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Tạm tính:</span>
                        <span style="color: #333; font-weight: 500;">${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(order.total_amount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #666;">Phí vận chuyển:</span>
                        <span style="color: #333; font-weight: 500;">Miễn phí</span>
                    </div>
                    <div style="border-top: 2px solid #ddd; margin: 15px 0; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #333; font-size: 1.1rem; font-weight: 600;">Tổng cộng:</span>
                        <span style="color: #e53935; font-size: 1.4rem; font-weight: 700;">${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(order.total_amount)}</span>
                    </div>
                </div>
            `;
            
            if (order.notes) {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <strong style="color: #856404;">Ghi chú:</strong>
                        <p style="margin: 5px 0 0 0; color: #856404;">${order.notes}</p>
                    </div>
                `;
            }
            
            document.getElementById('orderDetailContent').innerHTML = html;
            document.getElementById('orderDetailModal').style.display = 'block';
            
        } catch (error) {
            console.error('Error loading order detail:', error);
            showNotification('Không thể tải chi tiết đơn hàng!', 'error');
        }
    }
    
    function closeOrderDetailModal() {
        document.getElementById('orderDetailModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('orderDetailModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // ========== ENABLE EDIT PROFILE ==========
    function enableEditProfile() {
        const fullName = document.getElementById('fullName');
        const dateOfBirth = document.getElementById('dateOfBirth');
        const phone = document.getElementById('phone');
        const genderInputs = document.querySelectorAll('input[name="gender"]');
        const saveBtn = document.getElementById('saveProfileBtn');
        
        // Enable inputs
        fullName.removeAttribute('readonly');
        fullName.style.background = '#fff';
        fullName.style.color = '#333';
        fullName.style.borderColor = '#7c6240';
        
        // Convert DD/MM/YYYY to YYYY-MM-DD for date input BEFORE changing type
        const currentValue = dateOfBirth.value.trim();
        let dateValue = '';
        
        if (currentValue && currentValue.includes('/')) {
            const parts = currentValue.split('/');
            if (parts.length === 3) {
                // DD/MM/YYYY -> YYYY-MM-DD
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                dateValue = `${year}-${month}-${day}`;
            }
        } else if (currentValue && currentValue.includes('-')) {
            // Already in YYYY-MM-DD format
            dateValue = currentValue;
        }
        
        // Change to date type and set value
        dateOfBirth.type = 'date';
        dateOfBirth.value = dateValue;
        dateOfBirth.removeAttribute('readonly');
        dateOfBirth.style.background = '#fff';
        dateOfBirth.style.color = '#333';
        dateOfBirth.style.borderColor = '#7c6240';
        
        phone.removeAttribute('readonly');
        phone.style.background = '#fff';
        phone.style.color = '#333';
        phone.style.borderColor = '#7c6240';
        
        genderInputs.forEach(input => {
            input.removeAttribute('disabled');
            input.style.cursor = 'pointer';
        });
        
        // Show save button
        saveBtn.style.display = 'block';
        
        // Scroll to save button
        saveBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        showNotification('Bạn có thể chỉnh sửa thông tin ngay bây giờ!', 'info');
    }
    
    // ========== CHANGE AVATAR ==========
    function triggerAvatarUpload() {
        document.getElementById('avatarInput').click();
    }
    
    async function handleAvatarChange(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showNotification('Vui lòng chọn file ảnh!', 'warning');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Ảnh không được vượt quá 5MB!', 'warning');
            return;
        }
        
        // Show loading
        showNotification('Đang tải ảnh lên...', 'info');
        
        try {
            // Upload to server
            const formData = new FormData();
            formData.append('avatar', file);
            
            const token = localStorage.getItem('token');
            const response = await fetch('/api/users/upload-avatar', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Update avatars with new URL
                const avatarUrl = data.avatar;
                document.getElementById('profile-avatar').src = avatarUrl;
                document.getElementById('sidebar-avatar').src = avatarUrl;
                
                // Update currentUser
                if (window.currentUser) {
                    window.currentUser.avatar = avatarUrl;
                }
                
                showNotification('Ảnh đại diện đã được cập nhật!', 'success');
            } else {
                showNotification(data.error || 'Không thể tải ảnh lên!', 'error');
            }
        } catch (error) {
            console.error('Upload avatar error:', error);
            showNotification('Có lỗi xảy ra khi tải ảnh!', 'error');
        }
    }
    
    // Load saved avatar on page load (no longer needed - avatar loads from database)
    
    // ========== HANDLE PROFILE FORM SUBMIT ==========
    document.addEventListener('DOMContentLoaded', function() {
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const fullName = document.getElementById('fullName').value.trim();
                let dateOfBirth = document.getElementById('dateOfBirth').value;
                const phone = document.getElementById('phone').value.trim();
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                
                // Validate
                if (!fullName) {
                    showNotification('Vui lòng nhập họ tên!', 'warning');
                    return;
                }
                
                // Convert date from YYYY-MM-DD to DD/MM/YYYY for display
                let dateForDisplay = dateOfBirth;
                if (dateOfBirth && dateOfBirth.includes('-')) {
                    const parts = dateOfBirth.split('-');
                    if (parts.length === 3) {
                        dateForDisplay = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                }
                
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        showNotification('Vui lòng đăng nhập!', 'warning');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Show loading
                    const saveBtn = document.getElementById('saveProfileBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';
                    saveBtn.disabled = true;
                    
                    const response = await fetch('/api/users/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            full_name: fullName,
                            date_of_birth: dateOfBirth || null,
                            phone: phone || null,
                            gender: gender || null
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showNotification('Cập nhật thông tin thành công!', 'success');
                        
                        // Update sidebar username and avatars
                        document.getElementById('sidebar-username').textContent = fullName;
                        
                        // Update avatars (from database or generate new)
                        if (window.currentUser) {
                            const avatarUrl = window.currentUser.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=7c6240&color=fff&size=120`;
                            
                            const sidebarAvatar = document.getElementById('sidebar-avatar');
                            if (sidebarAvatar) {
                                sidebarAvatar.src = avatarUrl;
                            }
                            
                            const profileAvatar = document.getElementById('profile-avatar');
                            if (profileAvatar) {
                                profileAvatar.src = avatarUrl;
                            }
                        }
                        
                        // Disable inputs again
                        const fullNameInput = document.getElementById('fullName');
                        const dateInput = document.getElementById('dateOfBirth');
                        const phoneInput = document.getElementById('phone');
                        
                        fullNameInput.setAttribute('readonly', true);
                        fullNameInput.style.background = '#f8f9fa';
                        fullNameInput.style.color = '#666';
                        fullNameInput.style.borderColor = '#e0e0e0';
                        
                        dateInput.setAttribute('readonly', true);
                        dateInput.type = 'text';
                        dateInput.value = dateForDisplay;
                        dateInput.style.background = '#f8f9fa';
                        dateInput.style.color = '#666';
                        dateInput.style.borderColor = '#e0e0e0';
                        
                        phoneInput.setAttribute('readonly', true);
                        phoneInput.style.background = '#f8f9fa';
                        phoneInput.style.color = '#666';
                        phoneInput.style.borderColor = '#e0e0e0';
                        
                        document.querySelectorAll('input[name="gender"]').forEach(input => {
                            input.setAttribute('disabled', true);
                            input.style.cursor = 'not-allowed';
                        });
                        
                        // Hide save button
                        saveBtn.style.display = 'none';
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    } else {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        showNotification(data.error || 'Cập nhật thất bại!', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    const saveBtn = document.getElementById('saveProfileBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Lưu thay đổi';
                    saveBtn.disabled = false;
                    showNotification('Có lỗi xảy ra khi cập nhật thông tin!', 'error');
                }
            });
        }
        
        // Handle change password form
        const changePasswordForm = document.getElementById('changePasswordForm');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showNotification('Mật khẩu xác nhận không khớp!', 'warning');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('Mật khẩu mới phải có ít nhất 6 ký tự!', 'warning');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        showNotification('Vui lòng đăng nhập!', 'warning');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const response = await fetch('/api/users/change-password', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            currentPassword,
                            newPassword
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showNotification('Đổi mật khẩu thành công!', 'success');
                        this.reset();
                    } else {
                        showNotification(data.error || 'Đổi mật khẩu thất bại!', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Có lỗi xảy ra khi đổi mật khẩu!', 'error');
                }
            });
        }
    });
    
    // Make functions globally accessible
    window.enableEditProfile = enableEditProfile;
    window.triggerAvatarUpload = triggerAvatarUpload;
    window.handleAvatarChange = handleAvatarChange;
    </script>
</body>
</html> 





